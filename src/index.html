<!DOCTYPE html>
<html lang="en" charset="UTF-8">
<head>
    <meta charset="utf-8"/>
    <script src="../extension/lib/crypto.js" charset="UTF-8"></script>
    <title>E@syPe@syP@ss DUMP</title>
    <style>
        label, legend, fieldset {
            display: block;
            margin-top: 1rem;
            margin-bottom: .3rem;
        }
        section {
            margin: 1rem;
        }
        .mt {
            margin-top: 1rem
        }
    </style>
</head>

<body>

<section>
    <div>
        <div class="mt">
            <label for="import-text">Import text</label>
            <textarea rows="20" cols="120" id="import-text">
[
    {
        "site": "t12mdsnsg2dxgtq5lg2zKjE+KC6xJh+D",
        "user": "q128cey2gnHOkx0V9pmVqRCFZayqVzGy66tthQ==",
        "pass": "kkGc5y5uhHDfyS49bPmKBjh+oVt5sKSAwttsBQL7XtEr6w=="
    },
    {
        "site": "t12mdsnsg2dxgtq5lg2zKjE+KC6xJh+D",
        "user": "slm3RcG3lHbfzxMcceTTUi8rc+nffJevJ7OTUgJorwYQ",
        "template": "5/tYacO1gnD53A0YUf+Qel76sDsEIRRNWjyZ2Mx5vQ==",
        "script": "vlSqd9jqwGrf0RISP/2SRCZ+oW/3aftUmNLXoXHadeOORU2B"
    }
]</textarea>

        </div>
        <div>
            <label for="master-user">Master User</label>
            <input type="password" value="" id="master-user"><br>
        </div>
        <div>
            <label for="master-secret">Master Password</label>
            <input type="password" value="m@sterP@ssw0rd" id="master-secret"><br>
        </div>
    </div>
    <div>
        <label for="decrypt"></label>
        <button id="decrypt">Decrypt</button>
    </div>

    <hr>

    <div>
        <label for="plain">Plain Credentials</label>
        <textarea disabled="disabled" rows="20" cols="120" id="plain"></textarea>
    </div>

</section>

<script>
    async function decryptData(obj, secret) {
        for (let prop in obj) {
            if (Object.prototype.hasOwnProperty.call(obj, prop)) {
                if (prop.match(/^(site|pass|user|script)/)) {
                    obj[prop] = await easyPeasyAuth.decrypt(secret, obj[prop]);
                } else if (typeof obj[prop] === 'object') {
                    await decryptData(obj[prop], secret);
                }
            }
        }
    }

    document.getElementById('decrypt').addEventListener('click', async () => {
        const
            start = new Date(),
            secret = document.getElementById('master-user').value + document.getElementById('master-secret').value,
            importValue = JSON.parse(document.getElementById('import-text').value);

        await easyPeasyAuth.setSecret(secret)
        const derivedPass = await easyPeasyAuth.getDerivedPass();

        await decryptData(importValue, await easyPeasyAuth.getMySecretBlocks(derivedPass, false, 'SHARED_SECRET'));
        document.getElementById('plain').value = JSON.stringify(importValue, null, 4);

        alert(`duration: ${new Date() - start}ms`);
    });
</script>

</body>
</html>

<!--
[
    {
        "user": "test@test.ch",
        "pass": "MySâ‚¬cretP@ssw0rd",
        "site": "heise.de"
    },
    {
        "user": "max@mustermann.de",
        "site": "heise.de",
        "script": "alert('hello world')"
    }
]
-->